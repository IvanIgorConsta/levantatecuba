# ============================================================================
# CONFIGURACIÓN GLOBAL DE NGINX - LEVANTATECUBA
# Archivo: /etc/nginx/nginx.conf
# ============================================================================
# INSTRUCCIONES:
# Este archivo contiene las configuraciones que deben añadirse al
# archivo principal /etc/nginx/nginx.conf dentro del bloque http {}
# 
# NO reemplazar el archivo completo, solo añadir estas líneas.
# ============================================================================

# ============================================================================
# RATE LIMITING ZONES
# ============================================================================
# Zona para autenticación (más restrictiva)
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/m;

# Zona para API general
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;

# Zona para límite de conexiones simultáneas
limit_conn_zone $binary_remote_addr zone=addr:10m;

# ============================================================================
# CONFIGURACIÓN DE BUFFERS Y LÍMITES
# ============================================================================
# Buffer para el cuerpo de la petición
client_body_buffer_size 128k;

# CRÍTICO: Límite máximo de tamaño de upload
# Ajustado para permitir:
# - Imágenes de noticias: hasta 10MB
# - Reportes con múltiples archivos: hasta 20MB total
client_max_body_size 20m;

# Buffer para headers
client_header_buffer_size 1k;
large_client_header_buffers 4 8k;

# ============================================================================
# CONFIGURACIÓN DE TIMEOUTS
# ============================================================================
# Timeout para recibir el body completo (importante para uploads grandes)
client_body_timeout 30s;

# Timeout para recibir headers
client_header_timeout 12s;

# Timeout de keepalive
keepalive_timeout 65s;

# Timeout para enviar respuesta
send_timeout 30s;

# ============================================================================
# SEGURIDAD
# ============================================================================
# Ocultar versión de Nginx en headers
server_tokens off;

# Límite de conexiones simultáneas por IP
limit_conn addr 10;

# ============================================================================
# HTTP/3 (QUIC) - Solo si nginx está compilado con soporte
# ============================================================================
# Verificar con: nginx -V 2>&1 | grep -o with-http_v3_module
# Si está disponible, descomentar:
# quic_gso on;
# quic_retry on;

# ============================================================================
# LOGGING
# ============================================================================
# Formato de log extendido con información útil
log_format main_ext '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

# ============================================================================
# GZIP GLOBAL (Alternativa: configurar por servidor)
# ============================================================================
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript 
           application/json application/javascript application/xml+rss 
           application/rss+xml font/truetype font/opentype 
           application/vnd.ms-fontobject image/svg+xml;
gzip_min_length 1024;

# ============================================================================
# BROTLI (Si está instalado el módulo)
# ============================================================================
# Instalar: sudo apt install libbrotli-dev nginx-module-brotli
# Cargar módulo en nginx.conf (al inicio, fuera de http {}):
# load_module modules/ngx_http_brotli_filter_module.so;
# load_module modules/ngx_http_brotli_static_module.so;
#
# Luego descomentar:
# brotli on;
# brotli_comp_level 6;
# brotli_types text/plain text/css application/json application/javascript 
#              text/xml application/xml application/xml+rss text/javascript
#              image/svg+xml application/vnd.ms-fontobject font/truetype 
#              font/opentype;

# ============================================================================
# CACHE DE OPEN FILE DESCRIPTORS (Mejora performance)
# ============================================================================
open_file_cache max=10000 inactive=30s;
open_file_cache_valid 60s;
open_file_cache_min_uses 2;
open_file_cache_errors on;

# ============================================================================
# CONFIGURACIÓN DE WORKERS (Ajustar según CPU)
# ============================================================================
# Ya debería estar configurado al inicio del nginx.conf
# Descomentar si necesitas ajustar:
# worker_processes auto;
# worker_cpu_affinity auto;
# worker_rlimit_nofile 65535;
#
# events {
#     worker_connections 4096;
#     use epoll;
#     multi_accept on;
# }

# ============================================================================
# FASTCGI CACHE (Si usas PHP - NO APLICA para Node.js)
# ============================================================================
# No necesario para LevántateCuba

# ============================================================================
# EJEMPLO DE ESTRUCTURA COMPLETA:
# ============================================================================
# user www-data;
# worker_processes auto;
# pid /run/nginx.pid;
# 
# # Cargar módulos de Brotli si están instalados
# # load_module modules/ngx_http_brotli_filter_module.so;
# # load_module modules/ngx_http_brotli_static_module.so;
# 
# events {
#     worker_connections 4096;
#     use epoll;
#     multi_accept on;
# }
# 
# http {
#     # Basic Settings
#     sendfile on;
#     tcp_nopush on;
#     types_hash_max_size 2048;
#     
#     # AQUÍ VAN TODAS LAS CONFIGURACIONES DE ARRIBA
#     include /etc/nginx/mime.types;
#     default_type application/octet-stream;
#     
#     # Logging
#     access_log /var/log/nginx/access.log;
#     error_log /var/log/nginx/error.log;
#     
#     # Virtual Host Configs
#     include /etc/nginx/conf.d/*.conf;
#     include /etc/nginx/sites-enabled/*;
# }
# ============================================================================
